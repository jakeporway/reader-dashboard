<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Curation Lab v3</title>
    <style>
        /* CSS Variables */
        :root {
            --accent: #e85d4a;
            --accent-light: #f08a7a;
            --accent-dark: #d44335;
            --bg-primary: #fefcf8;
            --bg-secondary: #f9f5f0;
            --bg-card: #ffffff;
            --text-primary: #2c2c2c;
            --text-secondary: #666666;
            --text-light: #999999;
            --border: #e6e3de;
            --border-light: #f2f0ec;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.1);
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Header */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 2rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent);
            text-decoration: none;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--bg-secondary);
            padding: 0.25rem;
            border-radius: var(--radius-md);
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            min-height: 44px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .nav-tab.active {
            background: var(--bg-card);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .nav-badge {
            background: var(--accent);
            color: white;
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            min-width: 20px;
            text-align: center;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 44px;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-dark);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem 1rem;
            min-height: calc(100vh - 100px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Library Tab */
        .library-header {
            margin-bottom: 2rem;
        }

        .search-bar {
            width: 100%;
            padding: 1rem 1.5rem;
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 1rem;
            background: var(--bg-card);
            margin-bottom: 1.5rem;
            transition: var(--transition);
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--accent);
        }

        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-chip {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: 20px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: var(--transition);
            min-height: 36px;
            display: flex;
            align-items: center;
        }

        .filter-chip:hover {
            border-color: var(--accent);
        }

        .filter-chip.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .view-toggle {
            margin-left: auto;
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            padding: 0.5rem;
            border: 1px solid var(--border);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: var(--transition);
            min-height: 36px;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .view-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* Content Grid */
        .content-grid {
            display: grid;
            gap: 1.5rem;
        }

        .content-grid.list-view {
            grid-template-columns: 1fr;
        }

        .content-grid.board-view {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }

        @media (max-width: 768px) {
            .content-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        /* Content Cards */
        .content-card {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            overflow: hidden;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .content-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .content-card.unread::before {
            content: '';
            position: absolute;
            top: 12px;
            right: 12px;
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            z-index: 10;
        }

        .card-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background: var(--bg-secondary);
        }

        .card-content {
            padding: 1.5rem;
        }

        .card-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .card-meta {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .content-type {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .content-type.article { background: #e3f2fd; color: #1565c0; }
        .content-type.video { background: #fce4ec; color: #c2185b; }
        .content-type.interactive { background: #f3e5f5; color: #7b1fa2; }
        .content-type.podcast { background: #fff3e0; color: #ef6c00; }

        .source-name {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .paywall-icon {
            color: var(--text-light);
            font-size: 0.875rem;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }

        .card-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .card-description.truncated {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .show-more-btn {
            color: var(--accent);
            font-size: 0.875rem;
            background: none;
            border: none;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        .card-actions {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-light);
        }

        .action-btn {
            background: none;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            min-height: 36px;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:hover {
            background: var(--bg-secondary);
        }

        .action-btn.active {
            color: var(--accent);
        }

        .star-btn.active {
            color: #ffd700;
        }

        .rating-group {
            display: flex;
            gap: 0.25rem;
            margin-left: auto;
        }

        .rating-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: var(--radius-sm);
            transition: var(--transition);
            opacity: 0.5;
            min-height: 36px;
            min-width: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .rating-btn:hover,
        .rating-btn.active {
            opacity: 1;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: var(--text-primary);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: var(--transition);
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-size: 1rem;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
        }

        /* Draft Builder */
        .draft-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .draft-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            cursor: move;
            transition: var(--transition);
        }

        .draft-item:hover {
            box-shadow: var(--shadow-md);
        }

        .draft-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }

        .draft-item-header {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .draft-item-content {
            flex: 1;
        }

        .draft-item-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .draft-item-source {
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .draft-intro {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            font-family: inherit;
            resize: vertical;
            margin-bottom: 1rem;
        }

        .draft-highlights {
            margin-top: 1rem;
            padding: 1rem;
            background: #fffbf0;
            border: 1px solid #ffeaa7;
            border-radius: var(--radius-sm);
        }

        .draft-highlights h4 {
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .highlight-item {
            margin-bottom: 0.5rem;
            font-style: italic;
            color: var(--text-secondary);
        }

        /* Sources Tab */
        .source-feeds {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .source-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            transition: var(--transition);
        }

        .source-card:hover {
            box-shadow: var(--shadow-md);
        }

        .source-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .source-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .source-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-light);
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                align-items: stretch;
            }

            .nav-tabs {
                justify-content: center;
            }

            .filters {
                justify-content: center;
            }

            .view-toggle {
                margin-left: 0;
                justify-content: center;
            }

            .card-actions {
                flex-wrap: wrap;
            }

            .rating-group {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <a href="#" class="logo">Curation Lab</a>
            
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="library">
                    Library
                    <span class="nav-badge" id="today-picks-badge" style="display: none;">0</span>
                </button>
                <button class="nav-tab" data-tab="draft-builder">Draft Builder</button>
                <button class="nav-tab" data-tab="sources">Sources</button>
            </nav>
            
            <div class="header-actions">
                <button class="btn btn-primary" id="add-link-btn">+ Add Link</button>
                <button class="btn btn-secondary" id="sync-btn">Sync</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Library Tab -->
        <div class="tab-content active" id="library-tab">
            <div class="library-header">
                <input type="text" class="search-bar" placeholder="Search articles, sources, tags..." id="search-input">
                
                <div class="filters">
                    <div class="filter-group">
                        <div class="filter-chip active" data-type="all">All</div>
                        <div class="filter-chip" data-type="article">Articles</div>
                        <div class="filter-chip" data-type="video">Videos</div>
                        <div class="filter-chip" data-type="interactive">Interactive</div>
                        <div class="filter-chip" data-type="podcast">Podcasts</div>
                    </div>
                    
                    <div class="filter-group">
                        <div class="filter-chip" id="favorites-filter" data-filter="favorites">‚≠ê Favorites</div>
                        <div class="filter-chip" id="today-filter" data-filter="today">Today's Picks</div>
                    </div>
                    
                    <div class="view-toggle">
                        <button class="view-btn" data-view="list">‚ò∞</button>
                        <button class="view-btn active" data-view="board">‚äû</button>
                    </div>
                </div>
                
                <div class="filters">
                    <button class="btn btn-secondary" id="mark-all-read-btn">Mark All as Read</button>
                </div>
            </div>
            
            <div class="content-grid board-view" id="content-grid">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading content...</p>
                </div>
            </div>
        </div>

        <!-- Draft Builder Tab -->
        <div class="tab-content" id="draft-builder-tab">
            <div class="library-header">
                <h2>Draft Builder</h2>
                <p>Drag to reorder ‚Ä¢ Add personal commentary ‚Ä¢ Export when ready</p>
                
                <div class="filters">
                    <button class="btn btn-primary" id="copy-markdown-btn">Copy as Markdown</button>
                    <button class="btn btn-secondary" id="copy-text-btn">Copy as Plain Text</button>
                </div>
            </div>
            
            <div class="draft-items" id="draft-items">
                <div class="empty-state">
                    <h3>No favorites yet</h3>
                    <p>Star some articles in your library to start building a draft</p>
                </div>
            </div>
        </div>

        <!-- Sources Tab -->
        <div class="tab-content" id="sources-tab">
            <div class="library-header">
                <h2>Sources</h2>
                <p>RSS feeds powering your daily content</p>
            </div>
            
            <div class="source-feeds" id="source-feeds">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>Loading sources...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Link Modal -->
    <div class="modal" id="add-link-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Link</h2>
                <p>Paste any URL to add it to your library</p>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="link-url">URL</label>
                    <input type="url" class="form-input" id="link-url" placeholder="https://...">
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-add-link">Cancel</button>
                <button class="btn btn-primary" id="submit-add-link">Add Link</button>
            </div>
        </div>
    </div>

    <!-- Comment Modal -->
    <div class="modal" id="comment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Comment</h2>
                <p>Feedback for AI training</p>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="comment-text">Comment</label>
                    <textarea class="form-textarea" id="comment-text" placeholder="e.g., 'too academic', 'love this angle', 'needs more context'..."></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-comment">Cancel</button>
                <button class="btn btn-primary" id="submit-comment">Save Comment</button>
            </div>
        </div>
    </div>

    <!-- Highlight Modal -->
    <div class="modal" id="highlight-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Highlight</h2>
                <p>Save a quote or snippet</p>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="highlight-text">Highlight</label>
                    <textarea class="form-textarea" id="highlight-text" placeholder="Paste or type the text you want to highlight..."></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" id="cancel-highlight">Cancel</button>
                <button class="btn btn-primary" id="submit-highlight">Save Highlight</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast" id="toast"></div>

    <script>
        // Global State
        let appData = {
            items: [],
            favorites: new Set(),
            readItems: new Set(),
            feedback: {},
            highlights: {},
            customItems: [],
            currentTab: 'library',
            currentView: 'board',
            currentFilter: { type: 'all', favorites: false, today: false },
            searchQuery: ''
        };

        // Constants
        const SOURCE_FEEDS = [
            { name: 'The New York Times', url: 'https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml' },
            { name: 'The Guardian', url: 'https://www.theguardian.com/us/rss' },
            { name: 'Wired', url: 'https://www.wired.com/feed/rss' },
            { name: 'TechCrunch', url: 'https://techcrunch.com/feed/' },
            { name: 'The Atlantic', url: 'https://feeds.feedburner.com/TheAtlantic' },
            { name: 'Harvard Business Review', url: 'http://feeds.harvardbusiness.org/harvardbusiness' }
        ];

        const SYNC_URL_BASE = 'https://jsonblob.com/api/jsonBlob/';

        // Utility Functions
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function getTodayString() {
            return new Date().toISOString().split('T')[0];
        }

        function isToday(dateStr) {
            return dateStr === getTodayString();
        }

        // Local Storage Functions
        function loadFromStorage() {
            const feedback = localStorage.getItem('curator-feedback-v2');
            const highlights = localStorage.getItem('curator-highlights');
            const customItems = localStorage.getItem('curator-custom-items');
            const favorites = localStorage.getItem('curator-favorites');
            const readItems = localStorage.getItem('curator-read-items');

            if (feedback) appData.feedback = JSON.parse(feedback);
            if (highlights) appData.highlights = JSON.parse(highlights);
            if (customItems) appData.customItems = JSON.parse(customItems);
            if (favorites) appData.favorites = new Set(JSON.parse(favorites));
            if (readItems) appData.readItems = new Set(JSON.parse(readItems));
        }

        function saveToStorage() {
            localStorage.setItem('curator-feedback-v2', JSON.stringify(appData.feedback));
            localStorage.setItem('curator-highlights', JSON.stringify(appData.highlights));
            localStorage.setItem('curator-custom-items', JSON.stringify(appData.customItems));
            localStorage.setItem('curator-favorites', JSON.stringify([...appData.favorites]));
            localStorage.setItem('curator-read-items', JSON.stringify([...appData.readItems]));
        }

        // Data Loading
        async function loadData() {
            try {
                const response = await fetch('./data.json');
                const data = await response.json();
                
                // Convert days structure to flat items array
                appData.items = [];
                Object.entries(data.days).forEach(([date, dayData]) => {
                    dayData.items.forEach(item => {
                        appData.items.push({
                            ...item,
                            date: date,
                            pullDate: dayData.pullDate
                        });
                    });
                });

                // Add custom items
                appData.items = [...appData.items, ...appData.customItems];
                
                loadFromStorage();
                renderCurrentTab();
                updateTodayBadge();
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading data');
            }
        }

        // Filtering and Search
        function filterItems(items) {
            let filtered = items;

            // Search filter
            if (appData.searchQuery) {
                const query = appData.searchQuery.toLowerCase();
                filtered = filtered.filter(item => 
                    item.headline.toLowerCase().includes(query) ||
                    item.description.toLowerCase().includes(query) ||
                    item.source.toLowerCase().includes(query) ||
                    (item.tags && item.tags.some(tag => tag.toLowerCase().includes(query)))
                );
            }

            // Content type filter
            if (appData.currentFilter.type !== 'all') {
                filtered = filtered.filter(item => 
                    item.contentType.toLowerCase() === appData.currentFilter.type.toLowerCase()
                );
            }

            // Favorites filter
            if (appData.currentFilter.favorites) {
                filtered = filtered.filter(item => appData.favorites.has(item.id));
            }

            // Today filter (unreviewed items from today)
            if (appData.currentFilter.today) {
                const today = getTodayString();
                filtered = filtered.filter(item => 
                    isToday(item.date) && 
                    !appData.readItems.has(item.id) && 
                    !appData.favorites.has(item.id) &&
                    !appData.feedback[item.id]
                );
            }

            return filtered;
        }

        // UI Rendering
        function renderContentCard(item) {
            const isUnread = !appData.readItems.has(item.id);
            const isFavorited = appData.favorites.has(item.id);
            const feedback = appData.feedback[item.id];
            const highlights = appData.highlights[item.id] || [];

            return `
                <article class="content-card ${isUnread ? 'unread' : ''}" data-id="${item.id}">
                    ${item.image ? `<img src="${item.image}" alt="" class="card-image" loading="lazy">` : ''}
                    
                    <div class="card-content">
                        <div class="card-meta">
                            <span class="content-type ${item.contentType.toLowerCase()}">${item.contentType}</span>
                            <span class="source-name">${item.source}</span>
                            ${item.paywall ? '<span class="paywall-icon">üîí</span>' : ''}
                        </div>
                        
                        <h3 class="card-title" onclick="markAsRead('${item.id}')">${item.headline}</h3>
                        
                        <div class="card-description ${appData.currentView === 'board' ? 'truncated' : ''}" id="desc-${item.id}">
                            ${item.description}
                        </div>
                        
                        ${appData.currentView === 'board' ? `<button class="show-more-btn" onclick="toggleDescription('${item.id}')">Show more</button>` : ''}
                        
                        ${highlights.length > 0 ? `
                            <div class="draft-highlights">
                                <h4>Your highlights:</h4>
                                ${highlights.map(h => `<div class="highlight-item">"${h.text}"</div>`).join('')}
                            </div>
                        ` : ''}
                        
                        <div class="card-actions">
                            <button class="action-btn star-btn ${isFavorited ? 'active' : ''}" onclick="toggleFavorite('${item.id}')" title="Star as favorite">‚≠ê</button>
                            <button class="action-btn" onclick="openCommentModal('${item.id}')" title="Add comment">üí¨</button>
                            <button class="action-btn" onclick="openHighlightModal('${item.id}')" title="Add highlight">‚úèÔ∏è</button>
                            <a href="${item.url}" target="_blank" class="action-btn" onclick="markAsRead('${item.id}')" title="Read article">üîó</a>
                            
                            <div class="rating-group">
                                <button class="rating-btn ${feedback?.rating === 'up' ? 'active' : ''}" onclick="setRating('${item.id}', 'up')" title="Good">üëç</button>
                                <button class="rating-btn ${feedback?.rating === 'neutral' ? 'active' : ''}" onclick="setRating('${item.id}', 'neutral')" title="Neutral">ü§∑</button>
                                <button class="rating-btn ${feedback?.rating === 'down' ? 'active' : ''}" onclick="setRating('${item.id}', 'down')" title="Not great">üëé</button>
                            </div>
                        </div>
                    </div>
                </article>
            `;
        }

        function renderLibrary() {
            const grid = document.getElementById('content-grid');
            const filtered = filterItems(appData.items);
            
            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <h3>No items found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(renderContentCard).join('');
        }

        function renderDraftBuilder() {
            const container = document.getElementById('draft-items');
            const favorites = appData.items.filter(item => appData.favorites.has(item.id));
            
            if (favorites.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No favorites yet</h3>
                        <p>Star some articles in your library to start building a draft</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = favorites.map(item => {
                const highlights = appData.highlights[item.id] || [];
                
                return `
                    <div class="draft-item" draggable="true" data-id="${item.id}">
                        <div class="draft-item-header">
                            <div class="draft-item-content">
                                <h3 class="draft-item-title">${item.headline}</h3>
                                <div class="draft-item-source">${item.source} ‚Ä¢ ${formatDate(item.date)}</div>
                                
                                <textarea class="draft-intro" placeholder="Add your personal commentary or intro for this item..." 
                                    onchange="saveDraftIntro('${item.id}', this.value)">${item.draftIntro || ''}</textarea>
                                
                                ${highlights.length > 0 ? `
                                    <div class="draft-highlights">
                                        <h4>Your highlights:</h4>
                                        ${highlights.map(h => `<div class="highlight-item">"${h.text}"</div>`).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Set up drag and drop
            setupDragAndDrop();
        }

        function renderSources() {
            const container = document.getElementById('source-feeds');
            
            container.innerHTML = SOURCE_FEEDS.map(source => `
                <div class="source-card">
                    <h3 class="source-title">${source.name}</h3>
                    <p class="source-desc">RSS feed providing daily content updates</p>
                    <div class="source-stats">
                        <span>üì° RSS</span>
                        <span>üîÑ Active</span>
                    </div>
                </div>
            `).join('');
        }

        function renderCurrentTab() {
            switch (appData.currentTab) {
                case 'library':
                    renderLibrary();
                    break;
                case 'draft-builder':
                    renderDraftBuilder();
                    break;
                case 'sources':
                    renderSources();
                    break;
            }
        }

        function updateTodayBadge() {
            const today = getTodayString();
            const todayItems = appData.items.filter(item => 
                isToday(item.date) && 
                !appData.readItems.has(item.id) && 
                !appData.favorites.has(item.id) &&
                !appData.feedback[item.id]
            );
            
            const badge = document.getElementById('today-picks-badge');
            if (todayItems.length > 0) {
                badge.textContent = todayItems.length;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Action Functions
        function markAsRead(itemId) {
            appData.readItems.add(itemId);
            saveToStorage();
            
            // Update the card visually
            const card = document.querySelector(`[data-id="${itemId}"]`);
            if (card) card.classList.remove('unread');
            
            updateTodayBadge();
        }

        function toggleFavorite(itemId) {
            if (appData.favorites.has(itemId)) {
                appData.favorites.delete(itemId);
                // Remove draft intro when unfavorited
                const item = appData.items.find(i => i.id === itemId);
                if (item) delete item.draftIntro;
            } else {
                appData.favorites.add(itemId);
                markAsRead(itemId);
                // Auto-set positive feedback for starred items
                setRating(itemId, 'up');
            }
            
            saveToStorage();
            renderCurrentTab();
            updateTodayBadge();
            showToast(appData.favorites.has(itemId) ? 'Added to favorites' : 'Removed from favorites');
        }

        function setRating(itemId, rating) {
            if (!appData.feedback[itemId]) {
                appData.feedback[itemId] = {};
            }
            
            appData.feedback[itemId].rating = rating;
            appData.feedback[itemId].timestamp = Date.now();
            
            saveToStorage();
            markAsRead(itemId);
            renderCurrentTab();
            updateTodayBadge();
        }

        function openCommentModal(itemId) {
            window.currentItemId = itemId;
            const existing = appData.feedback[itemId]?.comment || '';
            document.getElementById('comment-text').value = existing;
            showModal('comment-modal');
        }

        function saveComment() {
            const itemId = window.currentItemId;
            const comment = document.getElementById('comment-text').value.trim();
            
            if (!comment) return;
            
            if (!appData.feedback[itemId]) {
                appData.feedback[itemId] = {};
            }
            
            appData.feedback[itemId].comment = comment;
            appData.feedback[itemId].timestamp = Date.now();
            
            saveToStorage();
            markAsRead(itemId);
            hideModal('comment-modal');
            showToast('Comment saved');
            updateTodayBadge();
        }

        function openHighlightModal(itemId) {
            window.currentItemId = itemId;
            document.getElementById('highlight-text').value = '';
            showModal('highlight-modal');
        }

        function saveHighlight() {
            const itemId = window.currentItemId;
            const text = document.getElementById('highlight-text').value.trim();
            
            if (!text) return;
            
            if (!appData.highlights[itemId]) {
                appData.highlights[itemId] = [];
            }
            
            appData.highlights[itemId].push({
                text: text,
                timestamp: Date.now()
            });
            
            saveToStorage();
            markAsRead(itemId);
            hideModal('highlight-modal');
            renderCurrentTab();
            showToast('Highlight saved');
            updateTodayBadge();
        }

        function toggleDescription(itemId) {
            const desc = document.getElementById(`desc-${itemId}`);
            const button = desc.nextElementSibling;
            
            if (desc.classList.contains('truncated')) {
                desc.classList.remove('truncated');
                button.textContent = 'Show less';
            } else {
                desc.classList.add('truncated');
                button.textContent = 'Show more';
            }
        }

        function saveDraftIntro(itemId, value) {
            const item = appData.items.find(i => i.id === itemId);
            if (item) {
                item.draftIntro = value;
                saveToStorage();
            }
        }

        function markAllAsRead() {
            const filtered = filterItems(appData.items);
            filtered.forEach(item => appData.readItems.add(item.id));
            saveToStorage();
            renderCurrentTab();
            updateTodayBadge();
            showToast('Marked all as read');
        }

        // Add Link Functions
        function addCustomLink() {
            const url = document.getElementById('link-url').value.trim();
            if (!url) return;

            const newItem = {
                id: `custom-${Date.now()}`,
                headline: url,
                description: 'Processing...',
                source: 'Custom Link',
                url: url,
                contentType: 'Article',
                image: '',
                tags: [],
                alignment: 3,
                paywall: false,
                date: getTodayString(),
                pullDate: formatDate(getTodayString())
            };

            appData.customItems.push(newItem);
            appData.items.push(newItem);
            saveToStorage();
            hideModal('add-link-modal');
            document.getElementById('link-url').value = '';
            renderCurrentTab();
            showToast('Link added to library');
        }

        // Draft Export Functions
        function exportAsMarkdown() {
            const favorites = appData.items.filter(item => appData.favorites.has(item.id));
            let markdown = '# Newsletter Draft\n\n';
            
            favorites.forEach(item => {
                markdown += `## ${item.headline}\n\n`;
                if (item.draftIntro) {
                    markdown += `${item.draftIntro}\n\n`;
                }
                
                const highlights = appData.highlights[item.id] || [];
                if (highlights.length > 0) {
                    highlights.forEach(h => {
                        markdown += `> "${h.text}"\n\n`;
                    });
                }
                
                markdown += `[Read more](${item.url}) ‚Ä¢ ${item.source}\n\n---\n\n`;
            });

            navigator.clipboard.writeText(markdown).then(() => {
                showToast('Copied as Markdown');
            });
        }

        function exportAsText() {
            const favorites = appData.items.filter(item => appData.favorites.has(item.id));
            let text = 'Newsletter Draft\n\n';
            
            favorites.forEach((item, index) => {
                text += `${index + 1}. ${item.headline}\n`;
                if (item.draftIntro) {
                    text += `${item.draftIntro}\n`;
                }
                
                const highlights = appData.highlights[item.id] || [];
                if (highlights.length > 0) {
                    highlights.forEach(h => {
                        text += `"${h.text}"\n`;
                    });
                }
                
                text += `${item.url}\n${item.source}\n\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                showToast('Copied as Plain Text');
            });
        }

        // Drag and Drop
        function setupDragAndDrop() {
            const container = document.getElementById('draft-items');
            let draggedElement = null;

            container.addEventListener('dragstart', (e) => {
                draggedElement = e.target.closest('.draft-item');
                if (draggedElement) {
                    draggedElement.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', draggedElement.outerHTML);
                }
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';

                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedElement);
                } else {
                    container.insertBefore(draggedElement, afterElement);
                }
            });

            container.addEventListener('dragend', (e) => {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.draft-item:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        // Sync Functions
        async function syncData() {
            const syncId = localStorage.getItem('curator-sync-id');
            if (!syncId) {
                showToast('No sync ID found');
                return;
            }

            const syncData = {
                feedback: appData.feedback,
                highlights: appData.highlights,
                readItems: [...appData.readItems],
                favorites: [...appData.favorites],
                customItems: appData.customItems,
                lastSync: Date.now()
            };

            try {
                const response = await fetch(SYNC_URL_BASE + syncId, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(syncData)
                });

                if (response.ok) {
                    showToast('Synced successfully');
                } else {
                    showToast('Sync failed');
                }
            } catch (error) {
                showToast('Sync error');
                console.error('Sync error:', error);
            }
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadData();

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    
                    // Update active tab
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Update active content
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    document.getElementById(tabId + '-tab').classList.add('active');
                    
                    appData.currentTab = tabId;
                    renderCurrentTab();
                });
            });

            // Search
            document.getElementById('search-input').addEventListener('input', (e) => {
                appData.searchQuery = e.target.value;
                renderCurrentTab();
            });

            // Content type filters
            document.querySelectorAll('.filter-chip[data-type]').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('.filter-chip[data-type]').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    appData.currentFilter.type = chip.dataset.type;
                    renderCurrentTab();
                });
            });

            // Special filters
            document.getElementById('favorites-filter').addEventListener('click', () => {
                const chip = document.getElementById('favorites-filter');
                appData.currentFilter.favorites = !appData.currentFilter.favorites;
                chip.classList.toggle('active', appData.currentFilter.favorites);
                renderCurrentTab();
            });

            document.getElementById('today-filter').addEventListener('click', () => {
                const chip = document.getElementById('today-filter');
                appData.currentFilter.today = !appData.currentFilter.today;
                chip.classList.toggle('active', appData.currentFilter.today);
                renderCurrentTab();
            });

            // View toggle
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    appData.currentView = btn.dataset.view;
                    
                    const grid = document.getElementById('content-grid');
                    grid.className = `content-grid ${appData.currentView}-view`;
                    renderCurrentTab();
                });
            });

            // Mark all as read
            document.getElementById('mark-all-read-btn').addEventListener('click', markAllAsRead);

            // Add link modal
            document.getElementById('add-link-btn').addEventListener('click', () => showModal('add-link-modal'));
            document.getElementById('cancel-add-link').addEventListener('click', () => hideModal('add-link-modal'));
            document.getElementById('submit-add-link').addEventListener('click', addCustomLink);

            // Comment modal
            document.getElementById('cancel-comment').addEventListener('click', () => hideModal('comment-modal'));
            document.getElementById('submit-comment').addEventListener('click', saveComment);

            // Highlight modal
            document.getElementById('cancel-highlight').addEventListener('click', () => hideModal('highlight-modal'));
            document.getElementById('submit-highlight').addEventListener('click', saveHighlight);

            // Draft builder actions
            document.getElementById('copy-markdown-btn').addEventListener('click', exportAsMarkdown);
            document.getElementById('copy-text-btn').addEventListener('click', exportAsText);

            // Sync
            document.getElementById('sync-btn').addEventListener('click', syncData);

            // Modal backdrop clicks
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.classList.remove('show');
                    }
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.querySelectorAll('.modal.show').forEach(modal => {
                        modal.classList.remove('show');
                    });
                }
            });
        });

        // Global functions for onclick handlers
        window.markAsRead = markAsRead;
        window.toggleFavorite = toggleFavorite;
        window.setRating = setRating;
        window.openCommentModal = openCommentModal;
        window.openHighlightModal = openHighlightModal;
        window.toggleDescription = toggleDescription;
        window.saveDraftIntro = saveDraftIntro;
    </script>
</body>
</html>
