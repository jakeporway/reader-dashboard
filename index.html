<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‚ú® Curation Lab</title>
<style>
  :root {
    --bg: #faf9f7;
    --card-bg: #ffffff;
    --text: #1a1a1a;
    --text-muted: #666;
    --accent: #e85d4a;
    --accent-light: #fff0ee;
    --border: #e8e6e3;
    --tag-bg: #f0eeeb;
    --shadow: 0 1px 3px rgba(0,0,0,0.06);
    --shadow-hover: 0 4px 12px rgba(0,0,0,0.1);
    --radius: 12px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif; background:var(--bg); color:var(--text); line-height:1.6; }

  .header { background:white; border-bottom:1px solid var(--border); padding:12px 24px; position:sticky; top:0; z-index:100; display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
  .header h1 { font-size:18px; font-weight:700; white-space:nowrap; }
  .header-actions { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
  .nav { display:flex; gap:3px; background:var(--tag-bg); border-radius:8px; padding:3px; }
  .nav button { padding:5px 10px; border:none; background:none; border-radius:6px; cursor:pointer; font-size:12px; font-weight:500; color:var(--text-muted); transition:all 0.2s; white-space:nowrap; }
  .nav button.active { background:white; color:var(--text); box-shadow:var(--shadow); }
  .btn-sm { padding:5px 10px; border:1px solid var(--border); border-radius:8px; background:white; cursor:pointer; font-size:12px; color:var(--text-muted); white-space:nowrap; }
  .btn-sm:hover { border-color:var(--accent); color:var(--accent); }

  /* Content Type Filters */
  .filters { padding:10px 24px; display:flex; gap:6px; flex-wrap:wrap; border-bottom:1px solid var(--border); background:white; align-items:center; }
  .filter-chip { padding:4px 10px; border:1px solid var(--border); border-radius:20px; font-size:11px; cursor:pointer; background:white; color:var(--text-muted); transition:all 0.2s; white-space:nowrap; }
  .filter-chip:hover, .filter-chip.active { background:var(--accent-light); border-color:var(--accent); color:var(--accent); }
  .date-nav { display:flex; align-items:center; gap:8px; margin-left:auto; }
  .date-nav button { background:none; border:none; cursor:pointer; font-size:16px; padding:2px 6px; border-radius:4px; }
  .date-nav button:hover { background:var(--tag-bg); }
  .date-label { font-size:13px; font-weight:500; color:var(--text); min-width:140px; text-align:center; }

  .main { max-width:900px; margin:0 auto; padding:20px 24px; }
  .pull-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; }
  .pull-header h2 { font-size:15px; color:var(--text-muted); font-weight:500; }
  .pull-stats { font-size:12px; color:var(--text-muted); }

  /* Cards */
  .card { background:var(--card-bg); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:12px; transition:all 0.2s; overflow:hidden; }
  .card:hover { box-shadow:var(--shadow-hover); border-color:#d0cec9; }
  .card-image { width:100%; height:180px; object-fit:cover; display:block; }
  .card-body { padding:16px 20px; }
  .card-type { display:inline-block; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:0.8px; padding:2px 8px; border-radius:4px; margin-bottom:8px; }
  .type-article { background:#e3f2fd; color:#1565c0; }
  .type-video { background:#fce4ec; color:#c62828; }
  .type-interactive { background:#e8f5e9; color:#2e7d32; }
  .type-framework { background:#fff3e0; color:#e65100; }
  .type-project { background:#f3e5f5; color:#6a1b9a; }
  .type-toolkit { background:#fff8e1; color:#f57f17; }
  .type-podcast { background:#fce4ec; color:#ad1457; }
  .type-visual-art { background:#ede7f6; color:#4527a0; }
  .type-audio { background:#e0f7fa; color:#00695c; }
  .type-immersive { background:#e8eaf6; color:#283593; }
  .card-source { font-size:11px; color:var(--accent); font-weight:600; display:inline; margin-left:8px; }
  .card-headline { font-size:17px; font-weight:600; line-height:1.4; margin-bottom:10px; }
  .card-headline a { color:var(--text); text-decoration:none; }
  .card-headline a:hover { color:var(--accent); }
  .card-description { font-size:14px; color:#444; line-height:1.7; margin-bottom:12px; }
  .card-description blockquote { border-left:3px solid var(--accent); padding-left:12px; margin:8px 0; font-style:italic; color:var(--text-muted); }
  .card-meta { display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
  .tag { font-size:10px; padding:2px 8px; background:var(--tag-bg); border-radius:4px; color:var(--text-muted); }
  .alignment { font-size:11px; font-weight:600; padding:2px 8px; border-radius:4px; }
  .alignment-5 { background:#e8f5e9; color:#2e7d32; }
  .alignment-4 { background:#f1f8e9; color:#558b2f; }
  .alignment-3 { background:#fff8e1; color:#f57f17; }
  .alignment-2 { background:#fff3e0; color:#e65100; }
  .alignment-1 { background:#fce4ec; color:#c62828; }
  .paywall-flag { font-size:10px; color:#ff9800; font-weight:600; }

  .card-actions { display:flex; align-items:center; gap:5px; padding:12px 20px; border-top:1px solid var(--border); background:#fafaf9; }
  .rate-btn { padding:5px 10px; border:1px solid var(--border); border-radius:8px; background:white; cursor:pointer; font-size:14px; transition:all 0.15s; }
  .rate-btn:hover { transform:scale(1.1); box-shadow:var(--shadow); }
  .rate-btn.selected { border-color:var(--accent); background:var(--accent-light); }
  .rate-btn .label { font-size:10px; color:var(--text-muted); }
  .comment-toggle { margin-left:auto; padding:5px 10px; border:1px solid var(--border); border-radius:8px; background:white; cursor:pointer; font-size:11px; color:var(--text-muted); }
  .comment-box { padding:0 20px 16px; display:none; }
  .comment-box.open { display:block; }
  .comment-box textarea { width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; font-family:inherit; font-size:13px; resize:vertical; min-height:50px; outline:none; }
  .comment-box textarea:focus { border-color:var(--accent); }
  .comment-box .save-comment { margin-top:6px; padding:4px 12px; background:var(--accent); color:white; border:none; border-radius:6px; font-size:11px; cursor:pointer; }

  /* Grid */
  .grid { columns:2 320px; column-gap:14px; }
  .grid .card { margin-bottom:14px; break-inside:avoid; display:inline-block; width:100%; }
  .grid .card-headline { font-size:15px; }
  .grid .card-description { font-size:12px; display:-webkit-box; -webkit-line-clamp:4; -webkit-box-orient:vertical; overflow:hidden; }
  .grid .card-image { height:auto; max-height:240px; }
  @media(max-width:700px) { .grid { columns:1; } }

  .empty-state { text-align:center; padding:60px 20px; color:var(--text-muted); }
  .empty-state .emoji { font-size:48px; margin-bottom:12px; }

  /* Draft */
  .draft-section { background:white; border:1px solid var(--border); border-radius:var(--radius); padding:24px; }
  .draft-preview { font-family:Georgia,serif; line-height:1.8; padding:20px; background:var(--bg); border-radius:8px; margin-top:12px; }
  .draft-preview h4 { font-size:15px; margin-bottom:4px; }
  .draft-preview .draft-link { color:var(--accent); text-decoration:none; }
  .draft-preview .draft-desc { font-size:14px; color:var(--text-muted); margin-bottom:16px; }
  .copy-draft { padding:8px 16px; background:var(--accent); color:white; border:none; border-radius:8px; cursor:pointer; font-size:13px; margin-top:12px; }

  /* Modal */
  .modal-overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.4); z-index:200; }
  .modal-overlay.open { display:flex; align-items:center; justify-content:center; }
  .modal { background:white; max-width:500px; width:90%; border-radius:12px; padding:24px; }
  .modal input, .modal textarea { width:100%; padding:10px; border:1px solid var(--border); border-radius:8px; font-size:14px; outline:none; box-sizing:border-box; font-family:inherit; }
  .modal textarea { min-height:60px; resize:vertical; margin-top:8px; font-size:13px; }


  .highlights { padding:0 20px 16px; }
  .highlight-item { background:linear-gradient(120deg, #fff9c4 0%, #fff59d 100%); padding:8px 12px; border-radius:6px; font-size:13px; font-style:italic; line-height:1.5; margin-bottom:6px; position:relative; border-left:3px solid #fdd835; }
  .highlight-item .remove-hl { position:absolute; top:4px; right:6px; background:none; border:none; cursor:pointer; font-size:10px; color:#999; opacity:0; transition:opacity 0.2s; }
  .highlight-item:hover .remove-hl { opacity:1; }
  .add-highlight { display:none; padding:0 20px 16px; }
  .add-highlight.open { display:block; }
  .add-highlight textarea { width:100%; padding:8px; border:1px solid var(--border); border-radius:6px; font-family:inherit; font-size:13px; resize:vertical; min-height:40px; outline:none; font-style:italic; }
  .add-highlight textarea:focus { border-color:#fdd835; }
  .add-highlight textarea::placeholder { color:#ccc; }
  .hl-actions { display:flex; gap:6px; margin-top:6px; }
  .hl-actions button { padding:4px 10px; border-radius:6px; font-size:11px; cursor:pointer; }
  .save-hl { background:#fdd835; color:#333; border:none; }
  .cancel-hl { background:white; border:1px solid var(--border); color:#666; }

  .toast { position:fixed; bottom:24px; right:24px; background:var(--text); color:white; padding:10px 18px; border-radius:8px; font-size:13px; opacity:0; transform:translateY(10px); transition:all 0.3s; z-index:1000; }
  .toast.show { opacity:1; transform:translateY(0); }

  @media(max-width:640px) { .header{padding:10px 16px;} .main{padding:16px;} .nav button{padding:4px 8px;font-size:11px;} .grid{grid-template-columns:1fr;} }
</style>
</head>
<body>

<div class="header">
  <h1>‚ú® Curation Lab</h1>
  <div class="header-actions">
    <nav class="nav">
      <button onclick="setView('feed')">üì∞ List</button>
      <button class="active" onclick="setView('board')">üìå Board</button>
      <button onclick="setView('favorites')">‚≠ê Favorites</button>
      <button onclick="setView('draft')">‚úçÔ∏è Draft</button>
      <button onclick="setView('sources')">üì° Sources</button>
    </nav>
    <button class="btn-sm" onclick="toggleAddLink()">‚ûï Add Link</button>
    <button class="btn-sm" onclick="exportFeedback()">üì§ Export</button>
    <span id="sync-status" style="font-size:11px;color:#ccc;">‚òÅÔ∏è</span>
  </div>
</div>

<div class="filters" id="filters"></div>

<div class="main">
  <div class="pull-header">
    <h2 id="pull-title">Loading...</h2>
    <span class="pull-stats" id="pull-stats"></span>
  </div>
  <div id="cards-container"></div>
</div>

<div class="modal-overlay" id="add-link-modal">
  <div class="modal">
    <h3 style="margin-bottom:12px;">‚ûï Add Your Own Link</h3>
    <input id="custom-url" type="url" placeholder="Paste URL here...">
    <textarea id="custom-note" placeholder="Why is this interesting? (optional)"></textarea>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button onclick="addCustomLink()" style="padding:8px 16px;background:var(--accent);color:white;border:none;border-radius:8px;cursor:pointer;font-size:13px;">Add Link</button>
      <button onclick="toggleAddLink()" style="padding:8px 16px;background:white;border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:13px;color:#666;">Cancel</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let currentView = 'board';
let activeFilters = new Set();
let allData = {};
let items = [];
let currentDate = null;
let availableDates = [];
let feedback = JSON.parse(localStorage.getItem('curator-feedback-v2') || '{}');

const CONTENT_TYPES = [
  { key:'article', label:'üìù Articles', icon:'üìù' },
  { key:'project', label:'üé® Projects', icon:'üé®' },
  { key:'visual-art', label:'üñºÔ∏è Visual Art', icon:'üñºÔ∏è' },
  { key:'interactive', label:'üéÆ Interactive', icon:'üéÆ' },
  { key:'video', label:'üé• Video', icon:'üé•' },
  { key:'audio', label:'üéß Audio', icon:'üéß' },
  { key:'podcast', label:'üéôÔ∏è Podcast', icon:'üéôÔ∏è' },
  { key:'framework', label:'üß∞ Framework', icon:'üß∞' },
  { key:'toolkit', label:'üîß Toolkit', icon:'üîß' },
  { key:'immersive', label:'‚ú® Immersive', icon:'‚ú®' },
];

async function loadData() {
  try {
    const resp = await fetch('data.json?v=' + Date.now());
    const data = await resp.json();
    if (data.days) {
      allData = data.days;
      availableDates = Object.keys(allData).sort().reverse();
      currentDate = availableDates[0];
      items = allData[currentDate]?.items || [];
    } else if (data.items) {
      allData = { 'today': { pullDate: data.pullDate, items: data.items } };
      availableDates = ['today'];
      currentDate = 'today';
      items = data.items;
    }
    loadCustomItems();
    renderFilters();
    renderCards();
    updateStats();
    updateTitle();
  } catch(e) {
    document.getElementById('pull-title').textContent = 'Waiting for first content pull...';
    document.getElementById('cards-container').innerHTML = '<div class="empty-state"><div class="emoji">üîç</div><p>Content incoming! Check back soon.</p></div>';
  }
}

function updateTitle() {
  const d = allData[currentDate];
  document.getElementById('pull-title').textContent = d?.pullDate || currentDate;
}

function navigateDate(dir) {
  const idx = availableDates.indexOf(currentDate);
  const newIdx = idx + dir;
  if (newIdx >= 0 && newIdx < availableDates.length) {
    currentDate = availableDates[newIdx];
    items = allData[currentDate]?.items || [];
    loadCustomItems();
    renderCards();
    updateStats();
    updateTitle();
  }
}

function renderFilters() {
  const container = document.getElementById('filters');
  const types = CONTENT_TYPES.filter(t => items.some(i => i.contentType === t.key));
  container.innerHTML = `
    <span class="filter-chip ${activeFilters.size===0?'active':''}" onclick="clearFilters()">All</span>
    ${types.map(t => `<span class="filter-chip ${activeFilters.has(t.key)?'active':''}" onclick="toggleFilter('${t.key}')">${t.label}</span>`).join('')}
    <div class="date-nav">
      <button onclick="navigateDate(1)" title="Previous day">‚óÄ</button>
      <span class="date-label" id="date-label">${allData[currentDate]?.pullDate || ''}</span>
      <button onclick="navigateDate(-1)" title="Next day">‚ñ∂</button>
    </div>
  `;
}

function toggleFilter(type) { if(activeFilters.has(type)) activeFilters.delete(type); else activeFilters.add(type); renderFilters(); renderCards(); updateStats(); }
function clearFilters() { activeFilters.clear(); renderFilters(); renderCards(); updateStats(); }

function getFilteredItems() {
  let f = items;
  if (activeFilters.size > 0) f = f.filter(i => activeFilters.has(i.contentType));
  if (currentView === 'favorites') f = f.filter(i => feedback[i.id]?.rating === 'fire' || feedback[i.id]?.rating === 'good');
  return f;
}

function renderCards() {
  const container = document.getElementById('cards-container');
  const filtered = getFilteredItems();

  if (currentView === 'sources') { renderSources(container); return; }
  if (currentView === 'draft') { renderDraft(container); return; }

  const isGrid = currentView === 'board';
  container.className = isGrid ? 'grid' : '';

  if (!filtered.length) {
    container.innerHTML = `<div class="empty-state"><div class="emoji">${currentView==='favorites'?'‚≠ê':'üîç'}</div><p>${currentView==='favorites'?'No favorites yet! Rate items to save them here.':'No items match this filter.'}</p></div>`;
    return;
  }

  container.innerHTML = filtered.map(item => {
    const fb = feedback[item.id] || {};
    const typeClass = 'type-' + (item.contentType || 'article');
    const desc = (item.description || '').replace(/\"([^\"]{20,})\"/g, '<blockquote>"$1"</blockquote>');
    return `
    <div class="card">
      ${item.image ? `<img class="card-image" src="${item.image}" onerror="this.style.display='none'" alt="">` : ''}
      <div class="card-body">
        <span class="card-type ${typeClass}">${item.contentType || 'article'}</span>
        <span class="card-source">${item.source}${item.paywall ? ' ¬∑ <span class="paywall-flag">üîí Paywall</span>' : ''}</span>
        <div class="card-headline"><a href="${item.url}" target="_blank">${item.headline}</a></div>
        <div class="card-description">${desc}</div>
        <div class="card-meta">
          ${(item.tags||[]).map(t => `<span class="tag">${t}</span>`).join('')}
          ${item.alignment ? `<span class="alignment alignment-${item.alignment}">Match: ${item.alignment}/5</span>` : ''}
        </div>
      </div>
      <div class="highlights" id="highlights-${item.id}"></div>
      <div class="add-highlight" id="add-hl-${item.id}">
        <textarea placeholder="Paste a quote or snippet you loved..." id="hl-textarea-${item.id}"></textarea>
        <div class="hl-actions">
          <button class="save-hl" onclick="saveHighlight('${item.id}')">üíõ Save Highlight</button>
          <button class="cancel-hl" onclick="toggleHighlight('${item.id}')">Cancel</button>
        </div>
      </div>
      <div class="card-actions">
        <button class="rate-btn ${fb.rating==='fire'?'selected':''}" onclick="rate('${item.id}','fire')">üî•</button>
        <button class="rate-btn ${fb.rating==='good'?'selected':''}" onclick="rate('${item.id}','good')">üëç</button>
        <button class="rate-btn ${fb.rating==='meh'?'selected':''}" onclick="rate('${item.id}','meh')">üòê</button>
        <button class="rate-btn ${fb.rating==='nope'?'selected':''}" onclick="rate('${item.id}','nope')">üëé</button>
        <button class="comment-toggle" onclick="toggleComment('${item.id}')">üí¨</button>
        <button class="comment-toggle" onclick="toggleHighlight('${item.id}')" style="margin-left:0;">‚úèÔ∏è Highlight</button>
      </div>
      <div class="comment-box ${fb.comment?'open':''}" id="comment-${item.id}">
        <textarea placeholder="What do you think? This helps me learn your taste..." id="textarea-${item.id}">${fb.comment||''}</textarea>
        <button class="save-comment" onclick="saveComment('${item.id}')">Save</button>
      </div>
    </div>`;
  }).join('');
}

function renderDraft(container) {
  const allItems = Object.values(allData).flatMap(d => d.items || []);
  const favs = allItems.filter(i => feedback[i.id]?.rating === 'fire' || feedback[i.id]?.rating === 'good');
  container.className = '';
  container.innerHTML = `
    <div class="draft-section">
      <h3>‚úçÔ∏è Weekly Draft Builder</h3>
      <p style="color:var(--text-muted);font-size:13px;margin-bottom:16px;">Your üî• and üëç items compiled for Substack. ${favs.length} items ready.</p>
      ${!favs.length ? '<div class="empty-state"><div class="emoji">‚úçÔ∏è</div><p>Rate some items first!</p></div>'
        : `<div class="draft-preview">${favs.map(i => `<h4><a class="draft-link" href="${i.url}" target="_blank">${i.headline}</a></h4><p class="draft-desc">${(i.description||'').replace(/<[^>]*>/g,'').slice(0,200)}...</p>`).join('')}</div>
           <button class="copy-draft" onclick="copyDraft()">üìã Copy to Clipboard</button>`}
    </div>`;
}

// Sources
const SOURCE_FEEDS = [
  {name:'Colossal',url:'https://www.thisiscolossal.com/feed/'},{name:'Kottke',url:'https://feeds.kottke.org/main'},
  {name:'Aeon',url:'https://aeon.co/feed.rss'},{name:'The Marginalian',url:'https://feeds.feedburner.com/brainpickings/rss'},
  {name:'Boing Boing',url:'https://boingboing.net/feed'},{name:'Atlas Obscura',url:'https://www.atlasobscura.com/feeds/latest'},
  {name:'It\'s Nice That',url:'https://feeds.feedburner.com/itsnicethat/SlXC'},{name:'Dense Discovery',url:'https://www.densediscovery.com/feed/'},
  {name:'Austin Kleon',url:'https://austinkleon.com/feed/'},{name:'SSIR',url:'https://ssir.org/site/rss_feed'},
  {name:'Behavioral Scientist',url:'https://behavioralscientist.org/feed/'},{name:'Nautilus',url:'https://nautil.us/feed/'},
  {name:'Places Journal',url:'https://placesjournal.org/feed/'},{name:'Farnam Street',url:'https://fs.blog/feed/'},
];
let activeSource = null;

function renderSources(container) {
  container.className = '';
  container.innerHTML = `<div style="display:flex;gap:20px;min-height:60vh;">
    <div style="min-width:180px;max-width:200px;">
      <h3 style="font-size:13px;color:var(--text-muted);margin-bottom:10px;text-transform:uppercase;letter-spacing:0.5px;">Sources</h3>
      ${SOURCE_FEEDS.map(s => `<div style="padding:7px 10px;border-radius:8px;cursor:pointer;font-size:12px;margin-bottom:3px;background:${activeSource===s.name?'var(--accent-light)':'transparent'};color:${activeSource===s.name?'var(--accent)':'var(--text)'};border:1px solid ${activeSource===s.name?'var(--accent)':'transparent'}" onclick="loadFeed('${s.url}','${s.name}')">${s.name}</div>`).join('')}
    </div>
    <div style="flex:1;" id="feed-content">
      <div class="empty-state"><div class="emoji">üì°</div><p>Pick a source to browse recent posts.</p></div>
    </div>
  </div>`;
}

async function loadFeed(url, name) {
  activeSource = name;
  renderCards();
  const fc = document.getElementById('feed-content');
  fc.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted);">Loading... ‚è≥</div>';
  try {
    const resp = await fetch('https://api.rss2json.com/v1/api.json?rss_url=' + encodeURIComponent(url));
    const data = await resp.json();
    if (data.status === 'ok' && data.items) {
      fc.innerHTML = data.items.slice(0,20).map(item => `
        <div class="card" style="margin-bottom:10px;">
          ${item.thumbnail?`<img class="card-image" src="${item.thumbnail}" onerror="this.style.display='none'">`:''} 
          <div class="card-body">
            <div class="card-source">${name} ¬∑ ${new Date(item.pubDate).toLocaleDateString()}</div>
            <div class="card-headline"><a href="${item.link}" target="_blank">${item.title}</a></div>
            <div class="card-description" style="font-size:13px;">${(item.description||'').replace(/<[^>]*>/g,'').slice(0,200)}...</div>
            <button class="btn-sm" style="margin-top:8px;" onclick="addFromFeed('${item.link.replace(/'/g,"\\'")}','${item.title.replace(/'/g,"\\'")}','${name}')">‚ûï Add to my feed</button>
          </div>
        </div>`).join('');
    } else { fc.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted);">Couldn\'t load feed.</div>'; }
  } catch(e) { fc.innerHTML = '<div style="padding:40px;text-align:center;color:var(--text-muted);">Feed unavailable.</div>'; }
}

function addFromFeed(url,title,source) {
  const n = {id:'feed-'+Date.now(),headline:title,source:source,url:url,description:'Added from '+source,tags:['from-feed'],contentType:'article',alignment:null,paywall:false,custom:true};
  items.unshift(n);
  const c = JSON.parse(localStorage.getItem('curator-custom-items')||'[]'); c.push(n); localStorage.setItem('curator-custom-items',JSON.stringify(c));
  showToast('Added! ‚ú®');
}

// Actions
function rate(id,rating) { if(!feedback[id])feedback[id]={}; feedback[id].rating=feedback[id].rating===rating?null:rating; feedback[id].timestamp=new Date().toISOString(); saveFeedback(); renderCards(); updateStats(); showToast(feedback[id].rating?`Rated ${({fire:'üî•',good:'üëç',meh:'üòê',nope:'üëé'})[rating]}`:'Cleared'); }
function toggleComment(id) { document.getElementById('comment-'+id)?.classList.toggle('open'); }
function saveComment(id) { const t=document.getElementById('textarea-'+id); if(!feedback[id])feedback[id]={}; feedback[id].comment=t.value; feedback[id].timestamp=new Date().toISOString(); saveFeedback(); showToast('Saved! üí¨'); }
function saveFeedback() { localStorage.setItem('curator-feedback-v2',JSON.stringify(feedback)); syncFeedback(); }
function toggleAddLink() { document.getElementById('add-link-modal').classList.toggle('open'); }
function addCustomLink() { const u=document.getElementById('custom-url').value.trim(),n=document.getElementById('custom-note').value.trim(); if(!u)return; const item={id:'custom-'+Date.now(),headline:n||u,source:'Custom',url:u,description:n||'Custom link',tags:['custom'],contentType:'article',alignment:null,paywall:false,custom:true}; items.unshift(item); const c=JSON.parse(localStorage.getItem('curator-custom-items')||'[]'); c.push(item); localStorage.setItem('curator-custom-items',JSON.stringify(c)); document.getElementById('custom-url').value=''; document.getElementById('custom-note').value=''; toggleAddLink(); renderCards(); updateStats(); showToast('Added! ‚ú®'); }
function loadCustomItems() { JSON.parse(localStorage.getItem('curator-custom-items')||'[]').forEach(c => { if(!items.find(i=>i.id===c.id)) items.unshift(c); }); }

function exportFeedback() {
  const data = Object.values(allData).flatMap(d => d.items||[]).map(i => ({headline:i.headline,source:i.source,url:i.url,contentType:i.contentType,rating:feedback[i.id]?.rating||'unrated',comment:feedback[i.id]?.comment||'',tags:i.tags}));
  const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`feedback-${new Date().toISOString().split('T')[0]}.json`; a.click();
  showToast('Exported! üì§');
}

function copyDraft() {
  const allItems = Object.values(allData).flatMap(d => d.items||[]);
  const favs = allItems.filter(i=>feedback[i.id]?.rating==='fire'||feedback[i.id]?.rating==='good');
  navigator.clipboard.writeText(`This Week's Finds ‚ú®\n\n`+favs.map(i=>`${i.headline}\n${i.url}\n${(i.description||'').replace(/<[^>]*>/g,'').slice(0,200)}\n`).join('\n'));
  showToast('Copied! üìã');
}

function setView(v) { currentView=v; document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.nav button').forEach(b=>{const t=b.textContent.toLowerCase(); if((v==='feed'&&t.includes('feed'))||(v==='board'&&t.includes('board'))||(v==='favorites'&&t.includes('fav'))||(v==='draft'&&t.includes('draft'))||(v==='sources'&&t.includes('source')))b.classList.add('active');}); renderCards(); updateStats(); }
function updateStats() { const f=getFilteredItems(); document.getElementById('pull-stats').textContent=`${f.length} items ¬∑ ${f.filter(i=>feedback[i.id]?.rating).length} rated`; }
function showToast(m) { const t=document.getElementById('toast'); t.textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),2000); }

// Sync
const SYNC_URL = 'https://jsonblob.com/api/jsonBlob';
let syncBlobId = localStorage.getItem('curator-sync-id') || null;
async function initSync() {
  if (!syncBlobId) { try { const r=await fetch(SYNC_URL,{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify({feedback:{},lastSync:new Date().toISOString()})}); if(r.ok){const l=r.headers.get('Location')||'';syncBlobId=l.split('/').pop()||null;if(syncBlobId){localStorage.setItem('curator-sync-id',syncBlobId);}} }catch(e){} }
  if(syncBlobId) document.getElementById('sync-status').textContent='‚òÅÔ∏è Synced';
}
async function syncFeedback() { if(!syncBlobId)await 
// === HIGHLIGHTS ===
let highlights = JSON.parse(localStorage.getItem('curator-highlights') || '{}');

function toggleHighlight(id) {
  document.getElementById('add-hl-' + id)?.classList.toggle('open');
  const ta = document.getElementById('hl-textarea-' + id);
  if (ta) ta.focus();
}

function saveHighlight(id) {
  const ta = document.getElementById('hl-textarea-' + id);
  const text = ta.value.trim();
  if (!text) return;
  if (!highlights[id]) highlights[id] = [];
  highlights[id].push({ text: text, timestamp: new Date().toISOString() });
  localStorage.setItem('curator-highlights', JSON.stringify(highlights));
  ta.value = '';
  toggleHighlight(id);
  renderHighlights(id);
  syncFeedback();
  showToast('Highlight saved! üíõ');
}

function removeHighlight(id, idx) {
  if (highlights[id]) {
    highlights[id].splice(idx, 1);
    if (!highlights[id].length) delete highlights[id];
    localStorage.setItem('curator-highlights', JSON.stringify(highlights));
    renderHighlights(id);
    syncFeedback();
  }
}

function renderHighlights(id) {
  const container = document.getElementById('highlights-' + id);
  if (!container) return;
  const hls = highlights[id] || [];
  container.innerHTML = hls.map((h, i) => 
    '<div class="highlight-item">"' + h.text + '"<button class="remove-hl" onclick="removeHighlight(\'' + id + '\',' + i + ')">‚úï</button></div>'
  ).join('');
}

// Render highlights on card render
const _origRenderCards = renderCards;
renderCards = function() {
  _origRenderCards();
  // Render highlights for visible items
  Object.keys(highlights).forEach(id => renderHighlights(id));
};

// Include highlights in sync
const _origSyncFb = syncFeedback;
syncFeedback = async function() {
  if (!syncBlobId) await initSync();
  if (!syncBlobId) return;
  try {
    await fetch(SYNC_URL + '/' + syncBlobId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({
        feedback: feedback,
        highlights: highlights,
        lastSync: new Date().toISOString(),
        ratedCount: Object.keys(feedback).filter(k => feedback[k]?.rating).length
      })
    });
  } catch(e) {}
};

// Include highlights in export
const _origExport = exportFeedback;
exportFeedback = function() {
  const allItems = Object.values(allData).flatMap(d => d.items||[]);
  const data = allItems.map(i => ({
    headline: i.headline, source: i.source, url: i.url, contentType: i.contentType,
    rating: feedback[i.id]?.rating || 'unrated',
    comment: feedback[i.id]?.comment || '',
    highlights: (highlights[i.id] || []).map(h => h.text),
    tags: i.tags
  }));
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'feedback-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  showToast('Exported! üì§');
};

initSync(); if(!syncBlobId)return; try{await fetch(SYNC_URL+'/'+syncBlobId,{method:'PUT',headers:{'Content-Type':'application/json','Accept':'application/json'},body:JSON.stringify({feedback,lastSync:new Date().toISOString(),ratedCount:Object.keys(feedback).filter(k=>feedback[k]?.rating).length})});}catch(e){} }


// === HIGHLIGHTS ===
let highlights = JSON.parse(localStorage.getItem('curator-highlights') || '{}');

function toggleHighlight(id) {
  document.getElementById('add-hl-' + id)?.classList.toggle('open');
  const ta = document.getElementById('hl-textarea-' + id);
  if (ta) ta.focus();
}

function saveHighlight(id) {
  const ta = document.getElementById('hl-textarea-' + id);
  const text = ta.value.trim();
  if (!text) return;
  if (!highlights[id]) highlights[id] = [];
  highlights[id].push({ text: text, timestamp: new Date().toISOString() });
  localStorage.setItem('curator-highlights', JSON.stringify(highlights));
  ta.value = '';
  toggleHighlight(id);
  renderHighlights(id);
  syncFeedback();
  showToast('Highlight saved! üíõ');
}

function removeHighlight(id, idx) {
  if (highlights[id]) {
    highlights[id].splice(idx, 1);
    if (!highlights[id].length) delete highlights[id];
    localStorage.setItem('curator-highlights', JSON.stringify(highlights));
    renderHighlights(id);
    syncFeedback();
  }
}

function renderHighlights(id) {
  const container = document.getElementById('highlights-' + id);
  if (!container) return;
  const hls = highlights[id] || [];
  container.innerHTML = hls.map((h, i) => 
    '<div class="highlight-item">"' + h.text + '"<button class="remove-hl" onclick="removeHighlight(\'' + id + '\',' + i + ')">‚úï</button></div>'
  ).join('');
}

// Render highlights on card render
const _origRenderCards = renderCards;
renderCards = function() {
  _origRenderCards();
  // Render highlights for visible items
  Object.keys(highlights).forEach(id => renderHighlights(id));
};

// Include highlights in sync
const _origSyncFb = syncFeedback;
syncFeedback = async function() {
  if (!syncBlobId) await initSync();
  if (!syncBlobId) return;
  try {
    await fetch(SYNC_URL + '/' + syncBlobId, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({
        feedback: feedback,
        highlights: highlights,
        lastSync: new Date().toISOString(),
        ratedCount: Object.keys(feedback).filter(k => feedback[k]?.rating).length
      })
    });
  } catch(e) {}
};

// Include highlights in export
const _origExport = exportFeedback;
exportFeedback = function() {
  const allItems = Object.values(allData).flatMap(d => d.items||[]);
  const data = allItems.map(i => ({
    headline: i.headline, source: i.source, url: i.url, contentType: i.contentType,
    rating: feedback[i.id]?.rating || 'unrated',
    comment: feedback[i.id]?.comment || '',
    highlights: (highlights[i.id] || []).map(h => h.text),
    tags: i.tags
  }));
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'feedback-' + new Date().toISOString().split('T')[0] + '.json';
  a.click();
  showToast('Exported! üì§');
};

initSync();
loadData();
</script>
</body>
</html>
